name: Build and Release

on:
    push:
        branches:
            - main
        paths:
            - "tools/**"
            - "QuaziiUI/**"
            - ".github/workflows/**"

    # Manual trigger
    workflow_dispatch:

permissions:
    contents: write # Allow the action to write to the repository (for creating tags/releases)
    discussions: read # Optional, adjust according to your needs

jobs:
    build:
        runs-on: ubuntu-latest

        concurrency:
            group: build-and-release-${{ github.ref }}
            cancel-in-progress: true

        steps:
            # Checkout the code
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for changelog generation

            # Ensure Python is available
            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'

            # Ensure zip is available
            - name: Ensure zip is installed
              run: sudo apt-get update && sudo apt-get install -y zip

            # Verify GitHub CLI availability
            - name: Verify GitHub CLI
              run: gh --version

            # Step 4: Set Version from Git Tags
            - name: Set Version from Git Tags
              id: set_version
              run: |
                  # Fetch all tags to ensure we have the latest version information
                  git fetch --tags
                  
                  # Get the latest semantic version tag (v1.0.x format)
                  LATEST_TAG=$(git tag -l "v1.0.*" | sort -V | tail -1)
                  
                  if [ -z "$LATEST_TAG" ]; then
                      # No v1.0.x tags exist, start with v1.0.1
                      NEW_VERSION="1.0.1"
                  else
                      # Extract the patch number and increment it
                      PATCH_VERSION=$(echo $LATEST_TAG | sed 's/v1\.0\.//')
                      NEW_PATCH=$((PATCH_VERSION + 1))
                      NEW_VERSION="1.0.$NEW_PATCH"
                  fi
                  
                  echo "TAG=v$NEW_VERSION" >> $GITHUB_ENV
                  echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
                  echo "ZIP_NAME=QuaziiUI-v$NEW_VERSION.zip" >> $GITHUB_ENV
                  echo "Latest semantic version tag: $LATEST_TAG"
                  echo "New version will be: v$NEW_VERSION"
            
            # Step 5: Modify QuaziiUI/init.lua if DEBUG_MODE is true
            - name: Check and update QuaziiUI.DEBUG_MODE in init.lua
              run: |
                  INIT_FILE="./QuaziiUI/init.lua"
                  
                  if grep -q "QuaziiUI.DEBUG_MODE = true" "$INIT_FILE"; then
                      echo "Debug: DEBUG_MODE is set to true. Updating to false."
                      sed -i 's/QuaziiUI.DEBUG_MODE = true/QuaziiUI.DEBUG_MODE = false/' "$INIT_FILE"
                  else
                      echo "Debug: DEBUG_MODE is already false or not found."
                  fi

            # Step 6: Ensure the version matches the release tag in QuaziiUI.toc
            - name: Update version in QuaziiUI.toc
              run: |
                  TOC_FILE="./QuaziiUI/QuaziiUI.toc"
                  echo "Debug: Updating .toc version to ${{ env.NEW_VERSION }}."
                  sed -i "s/@project-version@/${{ env.NEW_VERSION }}/g" "$TOC_FILE"

            # Step 7: Run build.py
            - name: Run build.py
              run: python tools/build.py

            # Step 8: Zip the QuaziiUI directory
            - name: Zip QuaziiUI directory
              run: |
                  echo "Debug: Zipping QuaziiUI directory to ${{ env.ZIP_NAME }}"
                  zip -r ${{ env.ZIP_NAME }} QuaziiUI

            # Step 9: Generate changelog
            - name: Generate changelog
              run: |
                  # Get the latest tag name across all branches
                  LAST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null)
                  
                  # Check if there are any tags
                  if [ -n "$LAST_TAG" ]; then
                      echo "Debug: Last tag found: $LAST_TAG"
                      echo "Changes since $LAST_TAG:" > CHANGELOG.md
                      git log $LAST_TAG..HEAD --oneline >> CHANGELOG.md
                  else
                      # If no tags exist, generate changelog for all commits
                      echo "Debug: No tags found, generating changelog for all commits."
                      echo "Changes since the beginning:" > CHANGELOG.md
                      git log --oneline >> CHANGELOG.md
                  fi

            - name: Output changelog
              id: changelog
              run: |
                  echo "Debug: Generated changelog content"
                  cat CHANGELOG.md

            # Step 10: Create GitHub Release
            - name: Create GitHub Release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "Debug: Creating release for tag ${{ env.TAG }}"
                  
                  # Check if release already exists
                  if gh release view ${{ env.TAG }} >/dev/null 2>&1; then
                    echo "Release ${{ env.TAG }} already exists. Deleting and recreating..."
                    gh release delete ${{ env.TAG }} --yes
                    # Also delete the tag if it exists
                    git tag -d ${{ env.TAG }} 2>/dev/null || true
                    git push origin --delete ${{ env.TAG }} 2>/dev/null || true
                  fi
                  
                  # Create the release
                  gh release create ${{ env.TAG }} \
                    ${{ env.ZIP_NAME }} \
                    --title "QuaziiUI ${{ env.TAG }}" \
                    --notes-file CHANGELOG.md \
                    --target main
