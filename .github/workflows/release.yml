name: Build and Release

on:
    push:
        branches:
            - main
        paths:
            - "tools/imports/**"

    # Manual trigger
    workflow_dispatch:

permissions:
    contents: write # Allow the action to write to the repository (for creating tags/releases)
    discussions: read # Optional, adjust according to your needs

jobs:
    build:
        runs-on: ubuntu-latest

        concurrency:
            group: build-and-release-${{ github.ref }}
            cancel-in-progress: true

        steps:
            # Step 1: Add a delay (sleep for 15 minutes = 900 seconds), only for push events
            - name: Wait for 15 minutes (only on push)
              if: github.event_name == 'push'
              run: sleep 900

            # Step 2: Checkout the code
            - name: Checkout code
              uses: actions/checkout@v3

            # Step 3: Install GitHub CLI (gh)
            - name: Install GitHub CLI
              run: sudo apt-get install gh

            # Step 4: Check if tag already exists without a release
            - name: Check existing tags
              id: tag_check
              run: |
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git config --global user.name "github-actions[bot]"

                  DATE=$(date +'%Y%m%d')
                  EXISTING_TAGS=$(git tag --list "$DATE*")
                  TAG_TO_USE="$DATE" # Default to just the date

                  # Check if there's already a tag with the exact date
                  if echo "$EXISTING_TAGS" | grep -q "^$DATE$"; then
                    COUNT=$(echo "$EXISTING_TAGS" | grep -E "^$DATE.?[0-9]?+$" | wc -l)
                    TAG_TO_USE="$DATE-$((COUNT+1))"
                  fi

                  echo "Using Tag: $TAG_TO_USE"

                  # Check if the tag exists remotely and push if not
                  if ! git ls-remote --tags origin | grep -q "refs/tags/$TAG_TO_USE"; then
                    git tag $TAG_TO_USE
                    git push origin $TAG_TO_USE
                  fi

                  echo "tag=$TAG_TO_USE" >> $GITHUB_ENV

            - name: Run build.py
              # Step 5: Run the Python build script
              run: python tools/build.py

            # Step 6: Zip the QuaziiUI directory
            - name: Zip QuaziiUI directory
              run: zip -r QuaziiUI_${{ env.tag }}.zip QuaziiUI

            # Step 7: Generate changelog from commit messages since last tag
            - name: Generate changelog
              run: |
                  # Check if there are any tags
                  if git describe --tags --abbrev=0 > /dev/null 2>&1; then
                    LAST_TAG=$(git describe --tags --abbrev=0)
                    echo "Changes since $LAST_TAG:" > CHANGELOG.md
                    git log $LAST_TAG..HEAD --oneline >> CHANGELOG.md
                  else
                    # If no tags, generate changelog for all commits
                    echo "Changes since the beginning:" > CHANGELOG.md
                    git log --oneline >> CHANGELOG.md
                  fi

            - name: Output changelog
              id: changelog
              run: cat CHANGELOG.md

            - name: Check if Release Exists
              # Step 8: Check if the release already exists
              id: release_check
              run: |
                  if git tag --list | grep -q "${{ env.tag }}"; then
                      if gh release view ${{ env.tag }} > /dev/null 2>&1; then
                          echo "Release for tag ${{ env.tag }} already exists. Skipping release creation."
                          echo "release_exists=true" >> $GITHUB_ENV
                      else
                          echo "Release for tag ${{ env.tag }} does not exist."
                          echo "release_exists=false" >> $GITHUB_ENV
                      fi
                  else
                      echo "Tag ${{ env.tag }} does not exist. Skipping release creation."
                      echo "release_exists=false" >> $GITHUB_ENV
                  fi

            - name: Check and Delete Existing Asset
              # Step 9: Check and Delete Existing Asset
              if: env.release_exists == 'false'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Set GH_TOKEN here
              run: |
                  ASSET_NAME="QuaziiUI_${{ env.tag }}.zip"
                  EXISTING_ASSET_ID=$(gh release view ${{ env.tag }} --json assets --jq ".assets | .[] | select(.name == \"$ASSET_NAME\") | .id" || true)

                  if [ ! -z "$EXISTING_ASSET_ID" ]; then
                    echo "Deleting existing asset: $ASSET_NAME"
                    gh release delete-asset ${{ env.tag }} $EXISTING_ASSET_ID --yes
                  else
                    echo "No existing asset named $ASSET_NAME found in release ${{ env.tag }}."
                  fi

            - name: Create or Update GitHub Release
              # Step 10: Create or update a GitHub Release using gh CLI
              if: env.release_exists == 'false'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Set GH_TOKEN here
              run: |
                  gh release create ${{ env.tag }} \
                    QuaziiUI_${{ env.tag }}.zip \
                    --title "QuaziiUI ${{ env.tag }}" \
                    --notes-file CHANGELOG.md \
                    --target main
